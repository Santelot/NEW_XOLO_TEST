<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceFlow Chatbot Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal h2 {
            color: #1a1a2e;
            margin-bottom: 0.5rem;
        }

        .modal p {
            color: #666;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .modal input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .modal input:focus {
            outline: none;
            border-color: #4a6cf7;
        }

        .modal button {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, #4a6cf7 0%, #6366f1 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header.hidden {
            display: none;
        }

        .user-badge {
            background: rgba(255, 255, 255, 0.15);
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .exit-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 77, 77, 0.8);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Main */
        main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        main.hidden {
            display: none;
        }

        #chatbot-container {
            width: 100%;
            max-width: 450px;
            height: 600px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            background: white;
        }

        footer {
            text-align: center;
            padding: 1rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <!-- Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <h2>ðŸ¤– VoiceFlow Demo</h2>
            <p>Ingresa un User ID. Si ya existe una conversaciÃ³n con ese ID, VoiceFlow deberÃ­a cargarla.</p>
            <input type="text" id="userIdInput" placeholder="Ej: santi_test_01" autocomplete="off">
            <button id="startChatBtn" disabled>Iniciar Chat</button>
        </div>
    </div>

    <!-- Header -->
    <header id="appHeader" class="hidden">
        <div>
            <strong>VoiceFlow Demo</strong>
            <span class="user-badge">ðŸ‘¤ <span id="userBadge"></span></span>
        </div>
        <button class="exit-btn" id="exitBtn">ðŸšª Cambiar Usuario</button>
    </header>

    <!-- Chat -->
    <main id="chatMain" class="hidden">
        <div id="chatbot-container"></div>
    </main>

    <footer>Testing phase â€” VoiceFlow maneja la persistencia de conversaciones</footer>

    <script type="text/javascript">
        const loginModal = document.getElementById('loginModal');
        const userIdInput = document.getElementById('userIdInput');
        const startChatBtn = document.getElementById('startChatBtn');
        const appHeader = document.getElementById('appHeader');
        const chatMain = document.getElementById('chatMain');
        const userBadge = document.getElementById('userBadge');
        const exitBtn = document.getElementById('exitBtn');

        userIdInput.addEventListener('input', () => {
            startChatBtn.disabled = userIdInput.value.trim() === '';
        });

        userIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && userIdInput.value.trim() !== '') {
                startChat();
            }
        });

        startChatBtn.addEventListener('click', startChat);

        let scriptLoaded = false;

        exitBtn.addEventListener('click', () => {
            // Limpiar TODO el localStorage relacionado con VoiceFlow
            // Esto es necesario para que acepte un nuevo userID
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('voiceflow') || key.includes('vf'))) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => {
                console.log('Eliminando:', key);
                localStorage.removeItem(key);
            });
            
            // Destruir el contenedor y crear uno nuevo
            const oldContainer = document.getElementById('chatbot-container');
            const parent = oldContainer.parentNode;
            oldContainer.remove();
            
            const newContainer = document.createElement('div');
            newContainer.id = 'chatbot-container';
            parent.appendChild(newContainer);
            
            // Mostrar modal, ocultar chat
            loginModal.classList.remove('hidden');
            appHeader.classList.add('hidden');
            chatMain.classList.add('hidden');
            
            // Limpiar input
            userIdInput.value = '';
            startChatBtn.disabled = true;
            userIdInput.focus();
            
            console.log('=== SesiÃ³n limpiada, listo para nuevo userID ===');
        });

        function startChat() {
            const userId = userIdInput.value.trim();
            
            console.log('=== Iniciando chat con userID:', userId, '===');
            
            loginModal.classList.add('hidden');
            appHeader.classList.remove('hidden');
            chatMain.classList.remove('hidden');
            userBadge.textContent = userId;

            const config = {
                verify: { projectID: '693206aef4f3f8cfea18fd06' },
                url: 'https://general-runtime.voiceflow.com',
                versionID: 'production',
                userID: userId,
                voice: {
                    url: "https://runtime-api.voiceflow.com"
                },
                render: {
                    mode: 'embedded',
                    target: document.getElementById('chatbot-container')
                },
                assistant: {
                    persistence: 'localStorage'  // Conversaciones persisten entre sesiones
                }
            };
            
            console.log('userID enviado:', config.userID);

            // Si el script ya estÃ¡ cargado, solo llamamos a load con el nuevo userID
            if (scriptLoaded && window.voiceflow && window.voiceflow.chat) {
                window.voiceflow.chat.load(config);
                return;
            }

            // Primera vez: cargar el script
            const script = document.createElement('script');
            script.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
            script.type = "text/javascript";
            script.onload = function() {
                scriptLoaded = true;
                window.voiceflow.chat.load(config);
            };
            document.head.appendChild(script);
        }

        userIdInput.focus();
    </script>
</body>
</html>
